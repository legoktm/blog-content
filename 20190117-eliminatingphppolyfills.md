Title: Eliminating PHP polyfills
Date: 2019-01-17 07:50:13
Category: MediaWiki
Tags: mediawiki, debian

The Symfony project has recently created a set of pure-PHP [polyfills](https://github.com/symfony/polyfill/) for both PHP extensions and newer language features. It allows developers to add requirements upon those functions or language additions without increasing the system requirements upon end users. For the most part, I think this is a good thing, and valuable to have. We've done similar things inside MediaWiki as well for CDB support, Memcached, and internationalization, just to name a few.

But the downside is that on platforms where it is possible to install the missing PHP extensions or upgrade PHP itself, we're shipping empty code. MediaWiki requires both the ctypes and mbstring PHP extensions, and our servers have those, so there's no use in deploying polyfills for those, because they'll never be used. In September, Reedy and I [replaced](https://gerrit.wikimedia.org/r/c/mediawiki/vendor/+/460464) the polyfills with "[unpolyfills](https://github.com/BackEndTea/un-poly-all)" that simply provide the correct package, so the polyfill is skipped by composer. That removed about 3,700 lines of code from what we're committing, reviewing, and deploying - a big win.

Last month I came across the same problem in Debian: [#911832](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=911832). The php-symfony-polyfill package was failing tests on the new PHP 7.3, and up for removal from the next stable release (Buster). On its own, the package isn't too important, but was a dependency of other important packages. In Debian, the polyfills are even more useless, since instead of depending upon e.g. `php-symfony-polyfill-mbstring`, the package could simply depend upon the native PHP extension, `php-mbstring`. In fact, there was already a system designed to implement those kinds of overrides. After looking at the dependencies, I uploaded a fixed version of php-webmozart-assert, filed bugs for two other packages. and provided patches for [symfony](https://salsa.debian.org/php-team/pear/symfony/merge_requests/1). I also made a patch to the default overrides in [pkg-php-tools](https://salsa.debian.org/php-team/pear/pkg-php-tools/merge_requests/1), so that any future package that depends upon a symfony polyfill should now automatically depend upon the native PHP extension if necessary.

Ideally composer would support alternative requirements like `ext-mbstring | php-symfony-polyfill-mbstring`, but that's been [declined by their developers](https://github.com/composer/composer/issues/751). There's [another issue](https://github.com/composer/composer/issues/5030) that is somewhat related, but doesn't do much to reduce the installation of polyfills when unnecessary.
